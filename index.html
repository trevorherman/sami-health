<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Sami Health">
<meta name="theme-color" content="#7C6BC4">
<meta name="description" content="Sami's Personal Health Tracker">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<title>Sami's Health Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body,#root{height:100%;width:100%}
body{font-family:'DM Sans',-apple-system,BlinkMacSystemFont,sans-serif;-webkit-font-smoothing:antialiased;overflow:hidden}
input[type=range]{-webkit-appearance:none;appearance:none;height:6px;border-radius:3px;outline:none}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;border-radius:50%;background:#7C6BC4;cursor:pointer;border:2px solid #fff;box-shadow:0 1px 4px rgba(0,0,0,.2)}
input[type=time],input[type=number],textarea{-webkit-appearance:none;font-family:inherit}
::-webkit-scrollbar{width:0;height:0}
</style>
</head>
<body>
<div id="root"><div style="min-height:100vh;display:flex;align-items:center;justify-content:center;background:#F5F0F7;font-family:sans-serif"><div style="text-align:center;color:#8A7FA0"><div style="font-size:32px;margin-bottom:12px">ğŸ’œ</div><div style="font-size:16px;font-weight:600">Loading Sami's Health Tracker...</div></div></div></div>

<!-- Dependencies loaded in correct order -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/recharts@2.12.7/umd/Recharts.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>

<script type="text/babel" data-presets="react">
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SAMI'S HEALTH TRACKER v3 â€” PWA Edition
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// Global destructuring (CDN UMD builds register on window)
const { useState, useEffect, useCallback, useRef } = React;
const { LineChart, Line, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Area, AreaChart, Legend, Cell } = Recharts;

// Register service worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(() => {});
}

const STORAGE_KEY = "sami-health-tracker-v3";

// â”€â”€â”€ Calming Color Palette â”€â”€â”€
const colors = {
  light: {
    bg: "#F5F0F7", bgCard: "#FFFFFF", bgCardAlt: "#F0EBF4",
    primary: "#7C6BC4", primaryLight: "#7C6BC420", primaryMid: "#7C6BC440",
    success: "#6BA38C", successLight: "#6BA38C20",
    warning: "#D4A054", warningLight: "#D4A05420",
    alert: "#C47EB0", alertLight: "#C47EB020",
    accent: "#5BA4C9", accentLight: "#5BA4C920",
    text: "#3D3155", textMuted: "#8A7FA0", textLight: "#B0A8C0",
    border: "#E4DDED", borderLight: "#EDE8F2",
    crisis: "#9B59B6", streak: "#E8B84B", reward: "#F0C75E",
  },
  dark: {
    bg: "#1C1726", bgCard: "#2A2338", bgCardAlt: "#322A42",
    primary: "#A594E0", primaryLight: "#A594E020", primaryMid: "#A594E040",
    success: "#7DB892", successLight: "#7DB89220",
    warning: "#E8C477", warningLight: "#E8C47720",
    alert: "#D49BC4", alertLight: "#D49BC420",
    accent: "#7BBDE0", accentLight: "#7BBDE020",
    text: "#E8E0F0", textMuted: "#9A8FB0", textLight: "#6A5F80",
    border: "#3E3550", borderLight: "#332A45",
    crisis: "#B07ACC", streak: "#F0D06E", reward: "#F5DA80",
  }
};

const QUOTES = [
  { text: "You don't have to feel great to show up. Showing up IS the win.", author: "Your Tracker" },
  { text: "Healing isn't linear. A bad day doesn't erase your progress.", author: "Reminder" },
  { text: "The fact that you're tracking this means you're fighting for yourself.", author: "Truth" },
  { text: "Rest is not quitting. Rest is how warriors reload.", author: "Your corner" },
  { text: "Small steps still move you forward. Every checkbox counts.", author: "Math" },
  { text: "You've survived 100% of your worst days. Undefeated record.", author: "The stats" },
  { text: "Your body is doing its best. Be kind to it today.", author: "A gentle nudge" },
  { text: "Consistency beats perfection. Always.", author: "Every streak ever" },
  { text: "Data is power. Every entry is ammunition for your healing.", author: "Your advocate" },
  { text: "Even on a 1/10 day, you're a 10/10 human.", author: "Trevor, probably" },
  { text: "1,000+ days on Duolingo? This doesn't stand a chance against you.", author: "Confidence" },
  { text: "Your patterns are telling a story. Keep writing chapters.", author: "The detective in you" },
  { text: "The doctors haven't figured it out yet, but the data might.", author: "Hope" },
  { text: "This isn't about perfection. It's about receipts for your doctor.", author: "Practical magic" },
  { text: "Breathe in 4. Hold 4. Out 6. You just did something healing.", author: "Right now" },
  { text: "A streak doesn't break from one missed day. It pauses.", author: "Grace" },
  { text: "Ice cream tastes even better when you've earned it.", author: "Motivation" },
  { text: "You are building a case file for your health. Detective-level.", author: "Respect" },
  { text: "Every good day proves what's possible. Every bad day shows what to investigate.", author: "Both matter" },
  { text: "Nobody who knows your story could call you anything but strong.", author: "Fact" },
];
function getDailyQuote(d) { const n = d.split("-").reduce((a, b) => a + parseInt(b), 0); return QUOTES[n % QUOTES.length]; }

const INFO = {
  restingHR: { title: "Why track resting heart rate?", body: "Measured lying down â€” a window into your autonomic nervous system. For POTS, a 30+ bpm jump on standing is a key marker. Daily tracking helps your doctor see patterns." },
  standingHR: { title: "Why standing HR?", body: "Normal standing raises HR 10-15 bpm. With POTS it can spike 30+ or above 120. Logging both builds evidence for your medical team." },
  morningHydration: { title: "Why 16oz first thing?", body: "After sleep, you're dehydrated. For POTS symptoms, dehydration worsens dizziness and HR spikes. 16oz right away stabilizes your cardiovascular system." },
  electrolytes: { title: "Why electrolytes?", body: "Sodium helps retain water and blood volume. Extra sodium (1000-3000mg/day) reduces dizziness, brain fog, and HR spikes. LMNT has ~1000mg per packet." },
  antimicrobial: { title: "Why before noon with food?", body: "Food prevents GI upset. Die-off reactions release neurotoxins â€” earlier means your body processes them during the day, not at night when they'd disrupt sleep and cause that 'wired' feeling." },
  magnesiumGlycinate: { title: "Why magnesium glycinate?", body: "Gentlest form on stomach. Supports relaxation, sleep, reduced anxiety, digestion. Glycine itself is calming! Take before 6 PM. Recommended: 200-400mg daily." },
  vitK2: { title: "Why Vitamin K2?", body: "Directs calcium to bones, supports blood clotting (important for heavy periods). Take with food containing fat. Recommended: 100-200mcg daily (MK-7 form)." },
  vitB2: { title: "Why Vitamin B2?", body: "Essential for cellular energy. Deficiency causes fatigue, light sensitivity, migraines. Recommended: 25-400mg daily depending on deficiency." },
  multivitamin: { title: "Why a multivitamin?", body: "Chronic issues use nutrients faster. Fills gaps when appetite is low or GI affects absorption. Nutritional insurance!" },
  digestiveEnzymes: { title: "Why digestive enzymes?", body: "Helps break down food completely. For bloating, burping, gas, or nausea after eating. Take WITH meals, not empty stomach." },
  gabapentin: { title: "Why Gabapentin at bedtime?", body: "Calms overactive nerves. Reduces anxiety, helps sleep, decreases nerve pain. Drowsiness helps at bedtime! Same time each night for steady levels." },
  unisom: { title: "About Unisom/Doxylamine", body: "Antihistamine sleep aid. At >50mg can paradoxically cause 'wired but tired.' We track doses to find your sweet spot." },
  vagalBreathing: { title: "Vagal Breathing Exercises", body: "Your vagus nerve = body's 'calm down' switch.\n\nğŸŒ¬ï¸ HOW TO:\n1. IN through nose â€” 4 seconds\n2. HOLD â€” 4 seconds\n3. OUT through mouth â€” 6-8 seconds\n4. Longer exhale is KEY!\n5. Repeat 5-10 min\n\nActivates vagus nerve, slows HR, calms anxiety. Even 2-3 min helps!" },
  screenFree: { title: "Why screen-free before bed?", body: "Blue light = 'stay awake' signal. Content keeps mind active. 1-2 hours screen-free lets melatonin happen naturally." },
  bedroomPrep: { title: "Why cool, dark, quiet?", body: "Body temp must DROP to sleep. Cool (65-68Â°F) helps. Darkness triggers melatonin. Quiet prevents micro-awakenings. Biology, not luxury!" },
  movement: { title: "Why track movement?", body: "Even 10-15 min walking regulates your autonomic system, circulation, digestion, mood. We track ANY movement to see correlations." },
  wiredButTired: { title: "What is 'wired but tired'?", body: "Body EXHAUSTED but mind RACING. Sympathetic system stuck in overdrive. Triggers: high Unisom, caffeine, anxiety, die-off reactions, hormones." },
  periodTracking: { title: "Why track your cycle?", body: "Hormones affect ALL symptoms. Worst days often cluster days 20-28. Tracking helps predict and prepare for tough stretches." },
  painNew: { title: "About pain tracking", body: "We know you have chronic neck, back, wrist pain. This tracks NEW/DIFFERENT pain above baseline. 0 = 'just my normal,' 10 = 'worst new pain ever.'" },
  sleepQuality: { title: "Rating sleep quality", body: "Not hours â€” how restorative?\n\n1-2: Barely slept\n3-4: Woke constantly\n5-6: Okay, some rest\n7-8: Good, restored\n9-10: Amazing, refreshed" },
  dayRating: { title: "Why rate your day?", body: "Simple ratings create powerful patterns. Bad clusters reveal triggers. Good clusters reveal your healing formula." },
};

// â”€â”€â”€ Utility Functions â”€â”€â”€
function fmtDate(d) { return d.toISOString().split("T")[0]; }
function fmtTime12(t) { if (!t) return "â€”"; const [h, m] = t.split(":").map(Number); return `${h % 12 || 12}:${String(m).padStart(2, "0")} ${h >= 12 ? "PM" : "AM"}`; }
function dayName(s) { return new Date(s + "T12:00:00").toLocaleDateString("en-US", { weekday: "short" }); }
function shortDate(s) { return new Date(s + "T12:00:00").toLocaleDateString("en-US", { month: "short", day: "numeric" }); }
function avg(a) { return a.length ? (a.reduce((x, y) => x + y, 0) / a.length).toFixed(1) : "â€”"; }

function getStreak(logs) {
  const today = new Date(); let streak = 0;
  for (let i = 0; i < 365; i++) {
    const d = new Date(today); d.setDate(d.getDate() - i);
    const k = fmtDate(d), log = logs[k];
    if (log && !log._isSample && log.dayRating) streak++;
    else if (i === 0) continue; else break;
  }
  return streak;
}
function getReward(s) {
  if (s >= 30) return { emoji: "ğŸ‘‘", msg: "30-day warrior!", reward: "Spa day earned!" };
  if (s >= 21) return { emoji: "ğŸŒŸ", msg: "21 days â€” official HABIT!", reward: "Pick your fav dessert!" };
  if (s >= 14) return { emoji: "ğŸ”¥", msg: "Two weeks strong!", reward: "Treat yourself!" };
  if (s >= 7) return { emoji: "ğŸ¦", msg: "7-DAY STREAK!", reward: "ICE CREAM TIME! ğŸ¦" };
  if (s >= 3) return { emoji: "â­", msg: `${s} days! Momentum!`, reward: null };
  if (s >= 1) return { emoji: "âœ¨", msg: `Day ${s}!`, reward: null };
  return { emoji: "ğŸŒ±", msg: "Start your streak!", reward: null };
}

function generateSampleData() {
  const today = new Date(), logs = {};
  [
    { o: -6, w: "11:15", b: "21:45", sq: 7, e: 6, a: 4, n: 2, mo: 7, r: "good", p: "none", cd: 20, rh: 78, sh: 95, ad: 90, wk: 1, rs: true, u: 25, wi: false, dz: 2, bu: 1, pc: 0, no: "Good day. Slept in, felt rested.", ew: false, fa: "22:30" },
    { o: -5, w: "11:30", b: "22:00", sq: 6, e: 5, a: 5, n: 3, mo: 6, r: "okay", p: "none", cd: 21, rh: 82, sh: 102, ad: 80, wk: 2, rs: false, u: 25, wi: false, dz: 3, bu: 3, pc: 0, no: "Okay day. Antimicrobial late.", ew: false, fa: "23:00" },
    { o: -4, w: "07:30", b: "21:30", sq: 3, e: 2, a: 8, n: 6, mo: 3, r: "bad", p: "spotting", cd: 22, rh: 98, sh: 128, ad: 55, wk: 4, rs: false, u: 50, wi: true, dz: 7, bu: 6, pc: 1, no: "Forced early wake for HBOT. Exhausted.", ew: true, fa: "01:00" },
    { o: -3, w: "12:00", b: "22:00", sq: 5, e: 4, a: 6, n: 4, mo: 5, r: "okay", p: "light", cd: 23, rh: 88, sh: 110, ad: 75, wk: 2, rs: false, u: 50, wi: true, dz: 4, bu: 4, pc: 0, no: "Recovering. Period starting.", ew: false, fa: "23:30" },
    { o: -2, w: "08:00", b: "21:00", sq: 2, e: 1, a: 9, n: 7, mo: 2, r: "crisis", p: "medium", cd: 24, rh: 105, sh: 135, ad: 40, wk: 5, rs: false, u: 75, wi: true, dz: 8, bu: 7, pc: 2, no: "Crisis. HR>120. Two panic attacks.", ew: true, fa: "02:00", cr: true },
    { o: -1, w: "12:30", b: "21:30", sq: 5, e: 3, a: 7, n: 5, mo: 4, r: "bad", p: "medium", cd: 25, rh: 92, sh: 118, ad: 65, wk: 3, rs: false, u: 50, wi: true, dz: 5, bu: 5, pc: 1, no: "Still recovering. Anxiety high.", ew: false, fa: "00:30" },
  ].forEach(d => {
    const dt = new Date(today); dt.setDate(dt.getDate() + d.o); const k = fmtDate(dt);
    logs[k] = {
      _isSample: true, date: k,
      sleep: { bedtime: d.b, fellAsleep: d.fa, wakeTime: d.w, quality: d.sq, wakings: d.wk, feltRested: d.rs, medication: { gabapentin: { taken: true, dose: 400 }, unisom: { taken: d.u > 0, dose: d.u } } },
      vitals: { morningHR: d.rh, standingHR: d.sh },
      symptoms: { anxiety: d.a, nausea: d.n, energy: d.e, mood: d.mo, dizziness: d.dz, burping: d.bu, panicCount: d.pc, wiredButTired: d.wi, irritability: Math.max(0, d.a - 2) },
      treatments: { morningHR: d.ad > 50, morningHydration: d.ad > 50, morningElectrolytes: d.ad > 50, antimicrobial: d.ad > 60, magnesium: d.ad > 50, digestiveEnzymes: d.ad > 60, multivitamin: d.ad > 50, vitK2: d.ad > 60, vitB2: d.ad > 60, movement: d.e > 3, bedtimeProtocol: d.ad > 70, screenFree: d.ad > 75, vagalBreathing: d.wi },
      menstrual: { status: d.p, cycleDay: d.cd },
      notes: d.no, dayRating: d.r,
      crisisEvents: d.cr ? [{ timestamp: k + "T15:00", type: ["severe_panic", "hr_over_120"], symptoms: ["racing_heart", "panic"], interventions: ["cold_water", "breathing"], partnerNote: "Really struggling." }] : [],
      earlyWake: d.ew, stressLevel: Math.min(10, d.a + 1),
    };
  });
  return logs;
}

// â”€â”€â”€ Reusable Components â”€â”€â”€
function InfoButton({ infoKey, c }) {
  const [open, setOpen] = useState(false);
  const info = INFO[infoKey]; if (!info) return null;
  return (<>
    <button onClick={e => { e.stopPropagation(); setOpen(!open); }} style={{ background: open ? c.primaryLight : "none", border: `1.5px solid ${open ? c.primary : c.border}`, borderRadius: 12, width: 22, height: 22, fontSize: 11, color: c.primary, cursor: "pointer", display: "inline-flex", alignItems: "center", justifyContent: "center", fontWeight: 700, flexShrink: 0 }}>?</button>
    {open && <div onClick={e => e.stopPropagation()} style={{ background: c.bgCard, border: `1.5px solid ${c.primary}`, borderRadius: 14, padding: 16, margin: "8px 0 4px", boxShadow: `0 4px 20px ${c.primaryLight}` }}>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 8 }}>
        <span style={{ fontSize: 13, fontWeight: 700, color: c.primary }}>{info.title}</span>
        <button onClick={() => setOpen(false)} style={{ background: "none", border: "none", fontSize: 16, color: c.textMuted, cursor: "pointer" }}>âœ•</button>
      </div>
      <p style={{ fontSize: 13, color: c.text, lineHeight: 1.65, margin: 0, whiteSpace: "pre-line" }}>{info.body}</p>
    </div>}
  </>);
}

function Slider({ value, onChange, min = 0, max = 10, label, lo, hi, c, ik }) {
  return (<div style={{ marginBottom: 16 }}>
    <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 4, gap: 8 }}>
      <div style={{ display: "flex", alignItems: "center", gap: 6, flex: 1 }}>
        <span style={{ fontSize: 14, fontWeight: 600, color: c.text }}>{label}</span>
        {ik && <InfoButton infoKey={ik} c={c} />}
      </div>
      <span style={{ fontSize: 14, fontWeight: 700, color: c.primary, minWidth: 24, textAlign: "right" }}>{value ?? "â€”"}</span>
    </div>
    <input type="range" min={min} max={max} value={value ?? 5} onChange={e => onChange(Number(e.target.value))} style={{ width: "100%", accentColor: c.primary, background: c.borderLight }} />
    <div style={{ display: "flex", justifyContent: "space-between", fontSize: 11, color: c.textMuted, marginTop: 2 }}><span>{lo || min}</span><span>{hi || max}</span></div>
  </div>);
}

function Toggle({ value, onChange, label, c, ik }) {
  return (<div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "10px 0", borderBottom: `1px solid ${c.borderLight}` }}>
    <span onClick={() => onChange(!value)} style={{ fontSize: 14, color: c.text, cursor: "pointer", flex: 1 }}>{label}</span>
    <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
      {ik && <InfoButton infoKey={ik} c={c} />}
      <div onClick={() => onChange(!value)} style={{ width: 48, height: 28, borderRadius: 14, background: value ? c.success : c.border, transition: "all .2s", cursor: "pointer", position: "relative", flexShrink: 0 }}>
        <div style={{ width: 22, height: 22, borderRadius: 11, background: "#fff", position: "absolute", top: 3, left: value ? 23 : 3, transition: "all .2s", boxShadow: "0 1px 3px rgba(0,0,0,.2)" }} />
      </div>
    </div>
  </div>);
}

function Card({ children, c, style = {} }) { return <div style={{ background: c.bgCard, borderRadius: 16, padding: 20, marginBottom: 12, border: `1px solid ${c.border}`, ...style }}>{children}</div>; }
function Pill({ text, active, onClick, c, color }) { return <button onClick={onClick} style={{ padding: "6px 14px", borderRadius: 20, border: "none", background: active ? (color || c.primary) : c.bgCardAlt, color: active ? "#fff" : c.textMuted, fontSize: 13, fontWeight: 600, cursor: "pointer" }}>{text}</button>; }

function CheckItem({ checked, onToggle, label, sublabel, warning, c, icon, infoKey }) {
  return (<div style={{ display: "flex", alignItems: "flex-start", gap: 12, padding: "12px 0", borderBottom: `1px solid ${c.borderLight}` }}>
    <div onClick={onToggle} style={{ width: 28, height: 28, borderRadius: 8, border: `2px solid ${checked ? c.success : c.border}`, background: checked ? c.success : "transparent", display: "flex", alignItems: "center", justifyContent: "center", flexShrink: 0, marginTop: 2, cursor: "pointer" }}>
      {checked && <span style={{ color: "#fff", fontSize: 16, fontWeight: 700 }}>âœ“</span>}
    </div>
    <div style={{ flex: 1 }}>
      <div style={{ display: "flex", alignItems: "center", gap: 6, flexWrap: "wrap" }}>
        <span onClick={onToggle} style={{ fontSize: 14, color: checked ? c.textMuted : c.text, textDecoration: checked ? "line-through" : "none", fontWeight: 500, cursor: "pointer" }}>{icon && <span style={{ marginRight: 6 }}>{icon}</span>}{label}</span>
        {infoKey && <InfoButton infoKey={infoKey} c={c} />}
      </div>
      {sublabel && <div style={{ fontSize: 12, color: c.textMuted, marginTop: 2 }}>{sublabel}</div>}
      {warning && !checked && <div style={{ fontSize: 12, color: c.warning, marginTop: 4, fontWeight: 500 }}>âš ï¸ {warning}</div>}
    </div>
  </div>);
}

function SH({ title, icon, c }) { return <h3 style={{ margin: "8px 0 12px", fontSize: 16, fontWeight: 700, color: c.text, display: "flex", alignItems: "center", gap: 8 }}>{icon && <span>{icon}</span>}{title}</h3>; }
function StatBox({ label, value, unit, c, color }) { return <div style={{ textAlign: "center", flex: 1, padding: "12px 8px", background: c.bgCardAlt, borderRadius: 12 }}><div style={{ fontSize: 26, fontWeight: 800, color: color || c.primary, lineHeight: 1.1 }}>{value ?? "â€”"}{unit && <span style={{ fontSize: 13, fontWeight: 500 }}>{unit}</span>}</div><div style={{ fontSize: 11, color: c.textMuted, marginTop: 4 }}>{label}</div></div>; }

function Counter({ value, onChange, label, c, color }) {
  return <div style={{ display: "flex", alignItems: "center", gap: 12, marginBottom: 12 }}>
    <span style={{ fontSize: 13, fontWeight: 600, color: c.text }}>{label}</span>
    <button onClick={() => onChange(Math.max(0, value - 1))} style={{ width: 36, height: 36, borderRadius: 10, border: `1px solid ${c.border}`, background: c.bgCardAlt, fontSize: 18, color: c.text, cursor: "pointer" }}>âˆ’</button>
    <span style={{ fontSize: 20, fontWeight: 700, color: color || c.primary, minWidth: 24, textAlign: "center" }}>{value}</span>
    <button onClick={() => onChange(value + 1)} style={{ width: 36, height: 36, borderRadius: 10, border: `1px solid ${c.border}`, background: c.bgCardAlt, fontSize: 18, color: c.text, cursor: "pointer" }}>+</button>
  </div>;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN APP (identical logic to artifact)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function App() {
  const [dark, setDark] = useState(false), [tab, setTab] = useState("today"), [logs, setLogs] = useState({}), [showCrisis, setShowCrisis] = useState(false), [showOnboarding, setShowOnboarding] = useState(false), [obStep, setObStep] = useState(0), [prefs, setPrefs] = useState({ bedtime: "21:30", wakeTime: "11:00" }), [logSub, setLogSub] = useState("morning"), [insRange, setInsRange] = useState(7), [loaded, setLoaded] = useState(false), [showExport, setShowExport] = useState(false), [exportText, setExportText] = useState(""), [viewDate, setViewDate] = useState(null), [quoteDismissed, setQuoteDismissed] = useState(false), [showSample, setShowSample] = useState(true), [showImport, setShowImport] = useState(false);

  const todayKey = fmtDate(new Date()), activeDate = viewDate || todayKey, isPast = viewDate && viewDate !== todayKey, c = dark ? colors.dark : colors.light, now = new Date(), currentHour = now.getHours(), greeting = currentHour < 12 ? "Good morning" : currentHour < 17 ? "Good afternoon" : "Good evening";

  useEffect(() => { if (currentHour >= 20 || currentHour < 6) setDark(true); }, []);
  useEffect(() => {
    try { const d = JSON.parse(localStorage.getItem(STORAGE_KEY)); if (d && d.logs && Object.keys(d.logs).length) { setLogs(d.logs); if (d.prefs) setPrefs(d.prefs); if (d.dark !== undefined) setDark(d.dark); setShowSample(Object.values(d.logs).some(l => l._isSample)); setLoaded(true); return; } } catch {}
    setLogs(generateSampleData()); setShowOnboarding(true); setLoaded(true);
  }, []);
  const saveRef = useRef(null);
  useEffect(() => { if (!loaded) return; clearTimeout(saveRef.current); saveRef.current = setTimeout(() => { try { localStorage.setItem(STORAGE_KEY, JSON.stringify({ logs, prefs, dark })); } catch {} }, 500); }, [logs, prefs, dark, loaded]);

  const emptyLog = d => ({ date: d, sleep: { bedtime: null, fellAsleep: null, wakeTime: null, quality: null, wakings: 0, feltRested: null, medication: { gabapentin: { taken: false, dose: 400 }, unisom: { taken: false, dose: 0 } } }, vitals: { morningHR: null, standingHR: null }, symptoms: { anxiety: null, nausea: null, energy: null, mood: null, dizziness: null, painNew: null, headache: null, burping: null, panicCount: 0, wiredButTired: null, irritability: null, fatigue: null, appetite: null }, treatments: {}, menstrual: { status: "none", cycleDay: null }, notes: "", dayRating: null, crisisEvents: [], earlyWake: false, stressLevel: null });
  const getLog = useCallback(d => logs[d] || emptyLog(d), [logs]);
  const updateLog = useCallback((d, fn) => { setLogs(p => { const ex = p[d] || emptyLog(d), u = typeof fn === "function" ? fn(ex) : { ...ex, ...fn }; if (u._isSample) delete u._isSample; return { ...p, [d]: u }; }); }, []);

  const currentLog = getLog(activeDate), allDates = Object.keys(logs).sort(), streak = getStreak(logs), reward = getReward(streak);
  function calcAdh(l) { if (!l?.treatments) return 0; const t = l.treatments; return Math.round([t.morningHR, t.morningHydration, t.morningElectrolytes, t.antimicrobial, t.magnesium, t.digestiveEnzymes, t.multivitamin, t.bedtimeProtocol].filter(Boolean).length / 8 * 100); }

  // â”€â”€â”€ Onboarding â”€â”€â”€
  if (showOnboarding) {
    const steps = [
      { t: "Welcome, Sami! ğŸ’œ", b: "This app was built just for you. It adapts to YOUR schedule, never judges, and is always in your corner." },
      { t: "Your Schedule ğŸ˜´", b: "Mornings aren't your thing â€” that's fine! Everything shifts based on when YOU wake up. Sleep in, it's medicine." },
      { t: "Tap the ? ğŸ’¡", b: "See a supplement and wonder why? Tap the purple ? next to anything for a plain-language explanation." },
      { t: "Streaks & Rewards ğŸ†", b: "1,000+ on Duolingo? We KNOW you can do this. Log daily â€” ice cream at day 7! ğŸ¦" },
      { t: "Crisis Button ğŸš¨", b: "The purple button is always there. For panic attacks or severe episodes. No pressure, just data." },
      { t: "Let's Go! ğŸ’œ", b: "Sample data is loaded to explore. Clear it in Settings when ready. Let's find some answers!" },
    ];
    const s = steps[obStep];
    return (<div style={{ minHeight: "100vh", background: c.bg, display: "flex", flexDirection: "column", justifyContent: "center", alignItems: "center", padding: 24 }}>
      <div style={{ maxWidth: 380, width: "100%", textAlign: "center" }}>
        <div style={{ display: "flex", gap: 6, justifyContent: "center", marginBottom: 32 }}>{steps.map((_, i) => <div key={i} style={{ width: 28, height: 4, borderRadius: 2, background: i <= obStep ? c.primary : c.border }} />)}</div>
        <h1 style={{ fontSize: 26, fontWeight: 800, color: c.text, marginBottom: 16 }}>{s.t}</h1>
        <p style={{ fontSize: 16, color: c.textMuted, lineHeight: 1.6, marginBottom: 40 }}>{s.b}</p>
        <div style={{ display: "flex", gap: 12 }}>
          {obStep > 0 && <button onClick={() => setObStep(p => p - 1)} style={{ flex: 1, padding: "14px 0", borderRadius: 12, border: `2px solid ${c.border}`, background: "transparent", color: c.textMuted, fontSize: 15, fontWeight: 600, cursor: "pointer" }}>Back</button>}
          <button onClick={() => obStep === steps.length - 1 ? setShowOnboarding(false) : setObStep(p => p + 1)} style={{ flex: 2, padding: "14px 0", borderRadius: 12, border: "none", background: c.primary, color: "#fff", fontSize: 15, fontWeight: 700, cursor: "pointer" }}>{obStep === steps.length - 1 ? "Let's Go! ğŸ’œ" : "Next"}</button>
        </div>
        {obStep < steps.length - 1 && <button onClick={() => setShowOnboarding(false)} style={{ marginTop: 16, background: "none", border: "none", color: c.textLight, fontSize: 13, cursor: "pointer", display: "block", width: "100%", textAlign: "center" }}>Skip</button>}
      </div>
    </div>);
  }

  // â”€â”€â”€ Date Nav â”€â”€â”€
  function DateNav() {
    const canNext = activeDate < todayKey;
    return (<div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 12, padding: "8px 4px", background: isPast ? c.accentLight : "transparent", borderRadius: 12 }}>
      <button onClick={() => { const p = allDates.filter(d => d < activeDate); if (p.length) setViewDate(p[p.length - 1]); }} style={{ background: "none", border: "none", fontSize: 22, color: c.primary, cursor: "pointer", padding: "4px 12px" }}>â€¹</button>
      <div style={{ textAlign: "center", flex: 1 }}>
        <div style={{ fontSize: 15, fontWeight: 700, color: c.text }}>{activeDate === todayKey ? "Today" : `${shortDate(activeDate)} (${dayName(activeDate)})`}</div>
        {isPast && <div style={{ fontSize: 11, color: c.accent, fontWeight: 600 }}>Viewing past{currentLog._isSample ? " (sample)" : ""}</div>}
      </div>
      <button onClick={() => { const n = allDates.filter(d => d > activeDate && d <= todayKey); if (n.length) setViewDate(n[0] === todayKey ? null : n[0]); else setViewDate(null); }} disabled={!canNext} style={{ background: "none", border: "none", fontSize: 22, color: canNext ? c.primary : c.textLight, cursor: canNext ? "pointer" : "default", padding: "4px 12px" }}>â€º</button>
    </div>);
  }

  // â”€â”€â”€ TODAY VIEW â”€â”€â”€
  function TodayView() {
    const log = currentLog, t = log.treatments || {}, adh = calcAdh(log), quote = getDailyQuote(activeDate);
    let ns = currentHour >= 20 ? "bed" : currentHour >= 17 ? "eve" : currentHour >= 12 ? "mid" : currentHour >= 8 ? "morn" : "wake";
    function tgl(f) { if (f === "_g") updateLog(activeDate, p => ({ ...p, sleep: { ...p.sleep, medication: { ...p.sleep?.medication, gabapentin: { taken: !p.sleep?.medication?.gabapentin?.taken, dose: 400 } } } })); else updateLog(activeDate, p => ({ ...p, treatments: { ...p.treatments, [f]: !p.treatments?.[f] } })); }
    function CL(items, title, status) {
      return (<Card c={c} style={status === "now" ? { border: `2px solid ${c.primary}`, boxShadow: `0 0 16px ${c.primaryLight}` } : {}}>
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 8 }}>
          <span style={{ fontSize: 14, fontWeight: 700, color: c.text }}>{title}</span>
          <span style={{ fontSize: 11, fontWeight: 600, color: status === "now" ? c.primary : status === "done" ? c.success : c.textMuted, padding: "3px 10px", borderRadius: 8, background: status === "now" ? c.primaryLight : status === "done" ? c.successLight : "transparent" }}>{status === "now" ? "â° DUE" : status === "done" ? "âœ“ DONE" : "UPCOMING"}</span>
        </div>
        {items.map((it, i) => <CheckItem key={i} {...it} c={c} onToggle={() => tgl(it.field)} />)}
      </Card>);
    }
    const yK = (() => { const d = new Date(activeDate + "T12:00:00"); d.setDate(d.getDate() - 1); return fmtDate(d); })(), yL = logs[yK];

    return (<div>
      <DateNav />
      {!quoteDismissed && !isPast && <Card c={c} style={{ background: `linear-gradient(135deg, ${c.primaryLight}, ${c.accentLight})`, border: `1px solid ${c.primaryMid}` }}>
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start" }}>
          <div style={{ flex: 1 }}><div style={{ fontSize: 14, fontWeight: 600, color: c.text, lineHeight: 1.5, fontStyle: "italic", marginBottom: 4 }}>"{quote.text}"</div><div style={{ fontSize: 11, color: c.textMuted, fontWeight: 600 }}>â€” {quote.author}</div></div>
          <button onClick={() => setQuoteDismissed(true)} style={{ background: "none", border: "none", color: c.textLight, fontSize: 16, cursor: "pointer", marginLeft: 8, flexShrink: 0 }}>âœ•</button>
        </div>
      </Card>}
      <div style={{ marginBottom: 16 }}><h1 style={{ margin: 0, fontSize: 26, fontWeight: 800, color: c.text }}>{greeting}, Sami ğŸ’œ</h1><p style={{ margin: "6px 0 0", fontSize: 14, color: c.textMuted }}>{yL?.sleep?.quality ? `Last night: ${yL.sleep.quality}/10 sleep` : "How are you feeling?"}</p></div>
      {streak > 0 && !isPast && <Card c={c} style={{ background: `linear-gradient(135deg, ${c.streak}15, ${c.reward}20)`, border: `1.5px solid ${c.streak}40` }}><div style={{ display: "flex", alignItems: "center", gap: 12 }}><div style={{ fontSize: 36 }}>{reward.emoji}</div><div style={{ flex: 1 }}><div style={{ fontSize: 22, fontWeight: 800, color: c.streak }}>{streak} Day Streak!</div><div style={{ fontSize: 13, color: c.text, fontWeight: 500 }}>{reward.msg}</div>{reward.reward && <div style={{ fontSize: 12, color: c.success, fontWeight: 600, marginTop: 4 }}>{reward.reward}</div>}{streak < 7 && <div style={{ fontSize: 11, color: c.textMuted, marginTop: 2 }}>{7 - streak} days until ice cream! ğŸ¦</div>}</div></div></Card>}
      <div style={{ display: "flex", gap: 8, marginBottom: 12 }}><StatBox label="Sleep" value={yL?.sleep?.quality} unit="/10" c={c} color={yL?.sleep?.quality >= 6 ? c.success : c.warning} /><StatBox label="Adherence" value={`${adh}%`} c={c} color={adh >= 80 ? c.success : c.warning} /><StatBox label="Today" value={log.dayRating ? { good: "ğŸ˜Š", okay: "ğŸ˜", bad: "ğŸ˜", crisis: "ğŸ˜«" }[log.dayRating] : "â€”"} c={c} /></div>
      {log.menstrual?.status && log.menstrual.status !== "none" && <div style={{ padding: "10px 16px", borderRadius: 12, background: c.alertLight, marginBottom: 12, fontSize: 13, fontWeight: 600, color: c.alert }}>ğŸ©¸ Period: {log.menstrual.status}{log.menstrual.cycleDay ? ` Â· Day ${log.menstrual.cycleDay}` : ""}</div>}
      {CL([{ checked: t.morningHR, label: "Log resting heart rate", icon: "ğŸ’“", field: "morningHR", infoKey: "restingHR" }, { checked: t.morningHydration, label: "Morning hydration (16 oz)", icon: "ğŸ’§", field: "morningHydration", infoKey: "morningHydration" }, { checked: t.morningElectrolytes, label: "Morning electrolytes", icon: "âš¡", field: "morningElectrolytes", sublabel: "LMNT (~1000mg sodium) or Liquid IV", infoKey: "electrolytes" }], "ğŸŒ… Wake-Up Protocol", [t.morningHR, t.morningHydration, t.morningElectrolytes].every(Boolean) ? "done" : ns === "wake" ? "now" : "upcoming")}
      {CL([{ checked: t.multivitamin, label: "Basic Nutrients 2/Day", icon: "ğŸ’Š", field: "multivitamin", infoKey: "multivitamin" }, { checked: t.vitK2, label: "Vitamin K2 (100-200mcg)", icon: "ğŸ’Š", field: "vitK2", infoKey: "vitK2" }, { checked: t.vitB2, label: "Vitamin B2 (25-400mg)", icon: "ğŸ’Š", field: "vitB2", infoKey: "vitB2" }], "ğŸ’Š Morning Supplements", [t.multivitamin, t.vitK2, t.vitB2].every(Boolean) ? "done" : ns === "morn" ? "now" : "upcoming")}
      {CL([{ checked: t.antimicrobial, label: "Antimicrobial tincture", icon: "ğŸŒ¿", field: "antimicrobial", sublabel: "WITH food Â· Before noon best", infoKey: "antimicrobial", warning: currentHour >= 12 && !t.antimicrobial ? "Past noon" : "" }], "ğŸŒ¿ Midday", t.antimicrobial ? "done" : ns === "mid" ? "now" : "upcoming")}
      {CL([{ checked: t.magnesium, label: "Magnesium glycinate (200-400mg)", icon: "ğŸ’Š", field: "magnesium", infoKey: "magnesiumGlycinate" }, { checked: t.digestiveEnzymes, label: "Digestive enzymes (with dinner)", icon: "ğŸ’Š", field: "digestiveEnzymes", infoKey: "digestiveEnzymes" }, { checked: t.movement, label: "Movement/exercise", icon: "ğŸš¶â€â™€ï¸", field: "movement", infoKey: "movement" }], "ğŸŒ† Afternoon/Evening", [t.magnesium, t.digestiveEnzymes].every(Boolean) ? "done" : ns === "eve" ? "now" : "upcoming")}
      {CL([{ checked: t.bedtimeProtocol, label: "Bedroom prepped (65-68Â°F, dark, quiet)", icon: "ğŸ›ï¸", field: "bedtimeProtocol", infoKey: "bedroomPrep" }, { checked: t.screenFree, label: "Screen-free (1+ hr)", icon: "ğŸ“µ", field: "screenFree", infoKey: "screenFree" }, { checked: t.vagalBreathing, label: "Vagal breathing (5-10 min)", icon: "ğŸŒ¬ï¸", field: "vagalBreathing", infoKey: "vagalBreathing" }, { checked: log.sleep?.medication?.gabapentin?.taken, label: "Gabapentin 400mg", icon: "ğŸ’Š", field: "_g", infoKey: "gabapentin" }], "ğŸŒ™ Bedtime", ns === "bed" ? "now" : [t.bedtimeProtocol, t.screenFree].every(Boolean) ? "done" : "upcoming")}
      <Card c={c}><div style={{ display: "flex", alignItems: "center", gap: 6, marginBottom: 12 }}><SH title="How's today?" icon="ğŸ“" c={c} /><InfoButton infoKey="dayRating" c={c} /></div>
        <div style={{ display: "flex", gap: 8 }}>{[["good", "ğŸ˜Š Good", c.success], ["okay", "ğŸ˜ Okay", c.primary], ["bad", "ğŸ˜ Bad", c.warning], ["crisis", "ğŸ˜« Crisis", c.alert]].map(([v, l, col]) => <button key={v} onClick={() => updateLog(activeDate, p => ({ ...p, dayRating: v }))} style={{ flex: 1, padding: "12px 4px", borderRadius: 12, border: `2px solid ${log.dayRating === v ? col : c.border}`, background: log.dayRating === v ? col + "20" : "transparent", fontSize: 13, fontWeight: 600, color: c.text, cursor: "pointer" }}>{l}</button>)}</div>
      </Card>
      <Card c={c}><SH title="Quick Note" icon="âœï¸" c={c} /><textarea value={log.notes || ""} onChange={e => updateLog(activeDate, p => ({ ...p, notes: e.target.value }))} placeholder="How are you feeling? What helped? What made things worse?" rows={3} style={{ width: "100%", padding: 12, borderRadius: 10, border: `1px solid ${c.border}`, background: c.bgCardAlt, color: c.text, fontSize: 14, fontFamily: "inherit", resize: "vertical", boxSizing: "border-box" }} /></Card>
    </div>);
  }

  // â”€â”€â”€ LOG VIEW â”€â”€â”€
  function LogView() {
    const log = currentLog;
    function ML() { return (<div>
      <Card c={c}><div style={{ display: "flex", alignItems: "center", gap: 6, marginBottom: 8 }}><SH title="Last Night's Sleep" icon="ğŸ˜´" c={c} /><InfoButton infoKey="sleepQuality" c={c} /></div>
        {[["Bedtime", "bedtime"], ["Fell asleep", "fellAsleep"], ["Wake time", "wakeTime"]].map(([l, f]) => <div key={f} style={{ marginBottom: 14 }}><label style={{ fontSize: 13, fontWeight: 600, color: c.text, display: "block", marginBottom: 6 }}>{l}</label><input type="time" value={log.sleep?.[f] || ""} onChange={e => updateLog(activeDate, p => ({ ...p, sleep: { ...p.sleep, [f]: e.target.value } }))} style={{ width: "100%", padding: 12, borderRadius: 10, border: `1px solid ${c.border}`, background: c.bgCardAlt, color: c.text, fontSize: 15, fontFamily: "inherit", boxSizing: "border-box" }} /></div>)}
        <Slider label="Sleep quality" value={log.sleep?.quality} onChange={v => updateLog(activeDate, p => ({ ...p, sleep: { ...p.sleep, quality: v } }))} lo="Terrible" hi="Perfect" c={c} />
        <Counter label="Night wakings" value={log.sleep?.wakings || 0} onChange={v => updateLog(activeDate, p => ({ ...p, sleep: { ...p.sleep, wakings: v } }))} c={c} />
        <Toggle label="Felt rested?" value={log.sleep?.feltRested || false} onChange={v => updateLog(activeDate, p => ({ ...p, sleep: { ...p.sleep, feltRested: v } }))} c={c} />
        <div style={{ marginTop: 16 }}><SH title="Sleep Meds" icon="ğŸ’Š" c={c} /></div>
        <Toggle label="Gabapentin 400mg" value={log.sleep?.medication?.gabapentin?.taken || false} onChange={v => updateLog(activeDate, p => ({ ...p, sleep: { ...p.sleep, medication: { ...p.sleep?.medication, gabapentin: { taken: v, dose: 400 } } } }))} c={c} ik="gabapentin" />
        <Toggle label="Unisom/Doxylamine" value={log.sleep?.medication?.unisom?.taken || false} onChange={v => updateLog(activeDate, p => ({ ...p, sleep: { ...p.sleep, medication: { ...p.sleep?.medication, unisom: { ...p.sleep?.medication?.unisom, taken: v } } } }))} c={c} ik="unisom" />
        {log.sleep?.medication?.unisom?.taken && <div style={{ marginTop: 8 }}><label style={{ fontSize: 13, fontWeight: 600, color: c.text, marginBottom: 6, display: "block" }}>Dose (mg)</label><input type="number" value={log.sleep?.medication?.unisom?.dose || ""} onChange={e => updateLog(activeDate, p => ({ ...p, sleep: { ...p.sleep, medication: { ...p.sleep?.medication, unisom: { ...p.sleep?.medication?.unisom, dose: Number(e.target.value) } } } }))} style={{ width: 120, padding: 10, borderRadius: 10, border: `1px solid ${c.border}`, background: c.bgCardAlt, color: c.text, fontSize: 15, fontFamily: "inherit" }} />{(log.sleep?.medication?.unisom?.dose || 0) > 50 && <div style={{ marginTop: 6, fontSize: 12, color: c.warning, fontWeight: 500 }}>âš ï¸ High dose â€” may cause "wired but tired"</div>}</div>}
        <Toggle label='"Wired but tired"?' value={log.symptoms?.wiredButTired || false} onChange={v => updateLog(activeDate, p => ({ ...p, symptoms: { ...p.symptoms, wiredButTired: v } }))} c={c} ik="wiredButTired" />
      </Card>
      <Card c={c}><SH title="Morning Vitals" icon="ğŸ’“" c={c} />
        <div style={{ display: "flex", gap: 12, marginBottom: 12 }}>{[["Resting HR", "morningHR", "restingHR"], ["Standing HR", "standingHR", "standingHR"]].map(([l, f, ik]) => <div key={f} style={{ flex: 1 }}><div style={{ display: "flex", alignItems: "center", gap: 4, marginBottom: 6 }}><label style={{ fontSize: 13, fontWeight: 600, color: c.text }}>{l}</label><InfoButton infoKey={ik} c={c} /></div><input type="number" value={log.vitals?.[f] || ""} placeholder="bpm" onChange={e => updateLog(activeDate, p => ({ ...p, vitals: { ...p.vitals, [f]: Number(e.target.value) } }))} style={{ width: "100%", padding: 12, borderRadius: 10, border: `1px solid ${c.border}`, background: c.bgCardAlt, color: c.text, fontSize: 15, fontFamily: "inherit", boxSizing: "border-box" }} /></div>)}</div>
        {log.vitals?.morningHR > 100 && <div style={{ fontSize: 12, color: c.alert, fontWeight: 500 }}>âš ï¸ Resting HR above 100</div>}
        {log.vitals?.standingHR && log.vitals?.morningHR && (log.vitals.standingHR - log.vitals.morningHR) > 30 && <div style={{ fontSize: 12, color: c.warning, fontWeight: 500 }}>âš ï¸ HR jumped {log.vitals.standingHR - log.vitals.morningHR} bpm â€” POTS indicator</div>}
      </Card>
      <Card c={c}><SH title="Waking Symptoms" icon="ğŸŒ…" c={c} />
        <Slider label="Energy" value={log.symptoms?.energy} onChange={v => updateLog(activeDate, p => ({ ...p, symptoms: { ...p.symptoms, energy: v } }))} lo="Can't move" hi="Energized" c={c} />
        <Slider label="Dizziness" value={log.symptoms?.dizziness} onChange={v => updateLog(activeDate, p => ({ ...p, symptoms: { ...p.symptoms, dizziness: v } }))} lo="None" hi="Severe" c={c} />
        <Slider label="Nausea" value={log.symptoms?.nausea} onChange={v => updateLog(activeDate, p => ({ ...p, symptoms: { ...p.symptoms, nausea: v } }))} lo="None" hi="Severe" c={c} />
        <Slider label="Anxiety" value={log.symptoms?.anxiety} onChange={v => updateLog(activeDate, p => ({ ...p, symptoms: { ...p.symptoms, anxiety: v } }))} lo="Calm" hi="Severe" c={c} />
        <Slider label="Mood" value={log.symptoms?.mood} onChange={v => updateLog(activeDate, p => ({ ...p, symptoms: { ...p.symptoms, mood: v } }))} lo="Low" hi="Great" c={c} />
      </Card>
    </div>); }

    function EL() { return (<div>
      <Card c={c}><div style={{ display: "flex", alignItems: "center", gap: 6, marginBottom: 8 }}><SH title="Menstrual" icon="ğŸ©¸" c={c} /><InfoButton infoKey="periodTracking" c={c} /></div>
        <div style={{ display: "flex", flexWrap: "wrap", gap: 8, marginBottom: 12 }}>{"none,spotting,light,medium,heavy".split(",").map(s => <Pill key={s} text={s[0].toUpperCase() + s.slice(1)} active={log.menstrual?.status === s} onClick={() => updateLog(activeDate, p => ({ ...p, menstrual: { ...p.menstrual, status: s } }))} c={c} color={s === "none" ? c.textMuted : c.alert} />)}</div>
        <label style={{ fontSize: 13, fontWeight: 600, color: c.text, marginBottom: 6, display: "block" }}>Cycle day</label>
        <input type="number" value={log.menstrual?.cycleDay || ""} onChange={e => updateLog(activeDate, p => ({ ...p, menstrual: { ...p.menstrual, cycleDay: Number(e.target.value) } }))} placeholder="Day" style={{ width: 100, padding: 10, borderRadius: 10, border: `1px solid ${c.border}`, background: c.bgCardAlt, color: c.text, fontSize: 15, fontFamily: "inherit" }} />
      </Card>
      <Card c={c}><SH title="GI Symptoms" icon="ğŸ« " c={c} />
        <Slider label="Nausea" value={log.symptoms?.nausea} onChange={v => updateLog(activeDate, p => ({ ...p, symptoms: { ...p.symptoms, nausea: v } }))} lo="None" hi="Severe" c={c} />
        <Slider label="Burping/Gas" value={log.symptoms?.burping} onChange={v => updateLog(activeDate, p => ({ ...p, symptoms: { ...p.symptoms, burping: v } }))} lo="None" hi="Severe" c={c} />
        <Slider label="Abdominal discomfort" value={log.symptoms?.pain} onChange={v => updateLog(activeDate, p => ({ ...p, symptoms: { ...p.symptoms, pain: v } }))} lo="None" hi="Severe" c={c} />
        <Slider label="Appetite" value={log.symptoms?.appetite} onChange={v => updateLog(activeDate, p => ({ ...p, symptoms: { ...p.symptoms, appetite: v } }))} lo="Couldn't eat" hi="Great" c={c} />
      </Card>
      <Card c={c}><SH title="Mental/Emotional" icon="ğŸ§ " c={c} />
        <Slider label="Peak anxiety" value={log.symptoms?.anxiety} onChange={v => updateLog(activeDate, p => ({ ...p, symptoms: { ...p.symptoms, anxiety: v } }))} lo="Calm" hi="Severe" c={c} />
        <Slider label="Mood" value={log.symptoms?.mood} onChange={v => updateLog(activeDate, p => ({ ...p, symptoms: { ...p.symptoms, mood: v } }))} lo="Worst" hi="Great" c={c} />
        <Slider label="Irritability" value={log.symptoms?.irritability} onChange={v => updateLog(activeDate, p => ({ ...p, symptoms: { ...p.symptoms, irritability: v } }))} lo="None" hi="Severe" c={c} />
        <Counter label="Panic episodes" value={log.symptoms?.panicCount || 0} onChange={v => updateLog(activeDate, p => ({ ...p, symptoms: { ...p.symptoms, panicCount: v } }))} c={c} color={(log.symptoms?.panicCount || 0) > 0 ? c.alert : c.success} />
      </Card>
      <Card c={c}><div style={{ display: "flex", alignItems: "center", gap: 6, marginBottom: 8 }}><SH title="Physical" icon="ğŸ¦´" c={c} /><InfoButton infoKey="painNew" c={c} /></div>
        <Slider label="Dizziness" value={log.symptoms?.dizziness} onChange={v => updateLog(activeDate, p => ({ ...p, symptoms: { ...p.symptoms, dizziness: v } }))} lo="None" hi="Severe" c={c} />
        <Slider label="NEW/unusual pain" value={log.symptoms?.painNew} onChange={v => updateLog(activeDate, p => ({ ...p, symptoms: { ...p.symptoms, painNew: v } }))} lo="Just normal" hi="Worst new" c={c} ik="painNew" />
        <Slider label="Headache" value={log.symptoms?.headache} onChange={v => updateLog(activeDate, p => ({ ...p, symptoms: { ...p.symptoms, headache: v } }))} lo="None" hi="Severe" c={c} />
        <Slider label="Fatigue" value={log.symptoms?.fatigue} onChange={v => updateLog(activeDate, p => ({ ...p, symptoms: { ...p.symptoms, fatigue: v } }))} lo="Fine" hi="Extreme" c={c} />
      </Card>
      <Card c={c}><SH title="Stress & Notes" icon="âœï¸" c={c} />
        <Slider label="Stress" value={log.stressLevel} onChange={v => updateLog(activeDate, p => ({ ...p, stressLevel: v }))} lo="Low" hi="Extreme" c={c} />
        <Toggle label="Forced early wake?" value={log.earlyWake || false} onChange={v => updateLog(activeDate, p => ({ ...p, earlyWake: v }))} c={c} />
        <textarea value={log.notes || ""} onChange={e => updateLog(activeDate, p => ({ ...p, notes: e.target.value }))} placeholder="What helped? What hurt?" rows={4} style={{ width: "100%", padding: 12, borderRadius: 10, border: `1px solid ${c.border}`, background: c.bgCardAlt, color: c.text, fontSize: 14, fontFamily: "inherit", resize: "vertical", boxSizing: "border-box", marginTop: 12 }} />
      </Card>
    </div>); }

    return (<div><DateNav />
      <h1 style={{ margin: "0 0 12px", fontSize: 24, fontWeight: 800, color: c.text }}>Daily Log</h1>
      <div style={{ display: "flex", gap: 8, marginBottom: 16 }}>{[["morning", "ğŸŒ… Morning"], ["evening", "ğŸŒ™ Evening"]].map(([k, l]) => <button key={k} onClick={() => setLogSub(k)} style={{ flex: 1, padding: "10px 0", borderRadius: 12, border: `2px solid ${logSub === k ? c.primary : c.border}`, background: logSub === k ? c.primaryLight : "transparent", color: logSub === k ? c.primary : c.textMuted, fontSize: 14, fontWeight: 600, cursor: "pointer" }}>{l}</button>)}</div>
      {logSub === "morning" ? <ML /> : <EL />}
    </div>);
  }

  // â”€â”€â”€ INSIGHTS â”€â”€â”€
  function InsightsView() {
    const src = allDates.slice(-insRange), drc = { good: c.success, okay: c.accent, bad: c.warning, crisis: c.alert };
    const chartData = src.map(d => { const l = logs[d]; return { date: dayName(d)[0] + new Date(d + "T12:00:00").getDate(), sleepQ: l?.sleep?.quality, energy: l?.symptoms?.energy, anxiety: l?.symptoms?.anxiety, mood: l?.symptoms?.mood, nausea: l?.symptoms?.nausea, hr: l?.vitals?.morningHR, standHR: l?.vitals?.standingHR, adherence: calcAdh(l) }; });
    const sq = src.map(d => logs[d]?.sleep?.quality).filter(Boolean), anx = src.map(d => logs[d]?.symptoms?.anxiety).filter(Boolean);
    const gd = src.filter(d => logs[d]?.dayRating === "good"), bd = src.filter(d => logs[d]?.dayRating === "bad" || logs[d]?.dayRating === "crisis");
    const ew = src.filter(d => logs[d]?.earlyWake), ewQ = ew.map(d => logs[d]?.sleep?.quality).filter(Boolean), nwQ = src.filter(d => !logs[d]?.earlyWake).map(d => logs[d]?.sleep?.quality).filter(Boolean);

    return (<div>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 }}><h1 style={{ margin: 0, fontSize: 24, fontWeight: 800, color: c.text }}>Insights</h1><div style={{ display: "flex", gap: 4 }}>{[7, 14, 30].map(n => <Pill key={n} text={`${n}d`} active={insRange === n} onClick={() => setInsRange(n)} c={c} />)}</div></div>
      <Card c={c}><SH title="Your Week" icon="ğŸ“…" c={c} />
        <div style={{ display: "flex", gap: 4, justifyContent: "center", flexWrap: "wrap" }}>{src.map(d => { const r = logs[d]?.dayRating, em = { good: "ğŸ˜Š", okay: "ğŸ˜", bad: "ğŸ˜", crisis: "ğŸ˜«" }[r] || "Â·"; return <div key={d} style={{ textAlign: "center", width: 44, cursor: "pointer" }} onClick={() => { setViewDate(d); setTab("today"); }}><div style={{ fontSize: 9, color: c.textMuted }}>{dayName(d)}</div><div style={{ width: 36, height: 36, borderRadius: 10, background: r ? drc[r] + "25" : c.bgCardAlt, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 18, margin: "0 auto" }}>{em}</div></div>; })}</div>
        <div style={{ fontSize: 11, color: c.textMuted, textAlign: "center", marginTop: 8 }}>Tap any day to view</div>
      </Card>
      <Card c={c}><SH title="Sleep Quality" icon="ğŸ˜´" c={c} />
        <ResponsiveContainer width="100%" height={160}><AreaChart data={chartData}><defs><linearGradient id="sg" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor={c.primary} stopOpacity={0.3} /><stop offset="95%" stopColor={c.primary} stopOpacity={0} /></linearGradient></defs><CartesianGrid strokeDasharray="3 3" stroke={c.borderLight} /><XAxis dataKey="date" tick={{ fontSize: 10, fill: c.textMuted }} /><YAxis domain={[0, 10]} tick={{ fontSize: 10, fill: c.textMuted }} /><Tooltip contentStyle={{ background: c.bgCard, border: `1px solid ${c.border}`, borderRadius: 8, fontSize: 12 }} /><Area type="monotone" dataKey="sleepQ" stroke={c.primary} fill="url(#sg)" strokeWidth={2.5} name="Quality" dot={{ r: 3, fill: c.primary }} /></AreaChart></ResponsiveContainer>
        <div style={{ fontSize: 12, color: c.textMuted, marginTop: 4 }}>Avg: {avg(sq)}/10</div>
      </Card>
      <Card c={c}><SH title="Anxiety vs Mood" icon="ğŸ§ " c={c} />
        <ResponsiveContainer width="100%" height={160}><LineChart data={chartData}><CartesianGrid strokeDasharray="3 3" stroke={c.borderLight} /><XAxis dataKey="date" tick={{ fontSize: 10, fill: c.textMuted }} /><YAxis domain={[0, 10]} tick={{ fontSize: 10, fill: c.textMuted }} /><Tooltip contentStyle={{ background: c.bgCard, border: `1px solid ${c.border}`, borderRadius: 8, fontSize: 12 }} /><Line type="monotone" dataKey="anxiety" stroke={c.warning} strokeWidth={2} name="Anxiety" dot={{ r: 3 }} /><Line type="monotone" dataKey="mood" stroke={c.success} strokeWidth={2} name="Mood" dot={{ r: 3 }} /><Legend wrapperStyle={{ fontSize: 11 }} /></LineChart></ResponsiveContainer>
      </Card>
      <Card c={c}><SH title="Heart Rate (POTS)" icon="ğŸ’“" c={c} />
        <ResponsiveContainer width="100%" height={160}><LineChart data={chartData}><CartesianGrid strokeDasharray="3 3" stroke={c.borderLight} /><XAxis dataKey="date" tick={{ fontSize: 10, fill: c.textMuted }} /><YAxis domain={[50, 150]} tick={{ fontSize: 10, fill: c.textMuted }} /><Tooltip contentStyle={{ background: c.bgCard, border: `1px solid ${c.border}`, borderRadius: 8, fontSize: 12 }} /><Line type="monotone" dataKey="hr" stroke={c.primary} strokeWidth={2} name="Resting" dot={{ r: 3 }} /><Line type="monotone" dataKey="standHR" stroke={c.warning} strokeWidth={2} name="Standing" dot={{ r: 3 }} /><Legend wrapperStyle={{ fontSize: 11 }} /></LineChart></ResponsiveContainer>
        <div style={{ fontSize: 12, color: c.textMuted, marginTop: 4 }}>30+ bpm gap may indicate POTS</div>
      </Card>
      <Card c={c}><SH title="Adherence" icon="ğŸ“‹" c={c} />
        <ResponsiveContainer width="100%" height={140}><BarChart data={chartData}><CartesianGrid strokeDasharray="3 3" stroke={c.borderLight} /><XAxis dataKey="date" tick={{ fontSize: 10, fill: c.textMuted }} /><YAxis domain={[0, 100]} tick={{ fontSize: 10, fill: c.textMuted }} /><Tooltip contentStyle={{ background: c.bgCard, border: `1px solid ${c.border}`, borderRadius: 8, fontSize: 12 }} formatter={v => v + "%"} /><Bar dataKey="adherence" name="%" radius={[4, 4, 0, 0]}>{chartData.map((e, i) => <Cell key={i} fill={e.adherence >= 80 ? c.success : e.adherence >= 50 ? c.warning : c.alert} fillOpacity={0.7} />)}</Bar></BarChart></ResponsiveContainer>
      </Card>
      <Card c={c} style={{ background: `linear-gradient(135deg, ${c.primaryLight}, ${c.successLight})`, border: `1px solid ${c.primaryMid}` }}>
        <SH title="What the Data Says" icon="ğŸ’¡" c={c} />
        <div style={{ display: "flex", flexDirection: "column", gap: 12 }}>
          {ewQ.length > 0 && nwQ.length > 0 && parseFloat(avg(nwQ)) > parseFloat(avg(ewQ)) && <div style={{ background: c.bgCard, borderRadius: 12, padding: 14 }}><div style={{ fontSize: 14, fontWeight: 700, color: c.text, marginBottom: 4 }}>ğŸ˜´ Sleeping In Helps!</div><div style={{ fontSize: 13, color: c.textMuted, lineHeight: 1.5 }}>Natural wake: {avg(nwQ)}/10 quality. Forced early: {avg(ewQ)}/10.</div></div>}
          {bd.length > 0 && <div style={{ background: c.bgCard, borderRadius: 12, padding: 14 }}><div style={{ fontSize: 14, fontWeight: 700, color: c.text, marginBottom: 4 }}>ğŸ” Bad Day Patterns</div><div style={{ fontSize: 13, color: c.textMuted, lineHeight: 1.5 }}>{bd.length} tough days: {bd.filter(d => logs[d]?.earlyWake).length} had early wakes, {bd.filter(d => logs[d]?.symptoms?.wiredButTired).length} had "wired but tired."</div></div>}
          <div style={{ background: c.bgCard, borderRadius: 12, padding: 14 }}><div style={{ fontSize: 14, fontWeight: 700, color: c.text, marginBottom: 4 }}>ğŸ“ˆ Numbers</div><div style={{ fontSize: 13, color: c.textMuted, lineHeight: 1.7 }}>Sleep: {avg(sq)}/10 Â· Anxiety: {avg(anx)}/10 Â· Panic days: {src.filter(d => logs[d]?.symptoms?.panicCount > 0).length}/{src.length} Â· Wired: {src.filter(d => logs[d]?.symptoms?.wiredButTired).length}/{src.length}</div></div>
        </div>
      </Card>
    </div>);
  }

  // â”€â”€â”€ SETTINGS â”€â”€â”€
  function SettingsView() {
    const [expR, setExpR] = useState("7");
    function genExp(r) { const ds = r === "all" ? allDates : allDates.slice(-parseInt(r)); if (!ds.length) return "No data."; let t = `=== SAMI HEALTH REPORT ===\n${shortDate(ds[0])} â€” ${shortDate(ds[ds.length - 1])} (${ds.length} days)\n\nSleep avg: ${avg(ds.map(d => logs[d]?.sleep?.quality).filter(Boolean))}/10\nRested: ${ds.filter(d => logs[d]?.sleep?.feltRested).length}/${ds.length}\nWired: ${ds.filter(d => logs[d]?.symptoms?.wiredButTired).length}/${ds.length}\nEarly wakes: ${ds.filter(d => logs[d]?.earlyWake).length}/${ds.length}\n`; ["anxiety", "nausea", "energy", "mood", "dizziness", "painNew", "headache", "fatigue"].forEach(k => { const v = ds.map(d => logs[d]?.symptoms?.[k]).filter(x => x != null); if (v.length) t += `${k}: avg ${avg(v)}/10\n`; }); t += `Panic total: ${ds.reduce((s, d) => s + (logs[d]?.symptoms?.panicCount || 0), 0)}\n`; const r2 = { good: 0, okay: 0, bad: 0, crisis: 0 }; ds.forEach(d => { if (logs[d]?.dayRating) r2[logs[d].dayRating]++; }); t += `\nDays: Good ${r2.good} | Okay ${r2.okay} | Bad ${r2.bad} | Crisis ${r2.crisis}\nAdherence: ${avg(ds.map(d => calcAdh(logs[d])))}%\n`; const notes = ds.filter(d => logs[d]?.notes); if (notes.length) { t += "\n=== NOTES ===\n"; notes.forEach(d => t += shortDate(d) + ": " + logs[d].notes + "\n\n"); } const cr = ds.flatMap(d => (logs[d]?.crisisEvents || []).map(e => ({ date: d, ...e }))); if (cr.length) { t += "\n=== CRISES ===\n"; cr.forEach(x => { t += x.date + ": " + (x.type?.join(", ") || "?") + "\n"; if (x.note) t += "  " + x.note + "\n"; if (x.partnerNote) t += "  Trevor: " + x.partnerNote + "\n"; }); } return t; }
    function genCSV(r) { const ds = r === "all" ? allDates : allDates.slice(-parseInt(r)); return "Date,Rating,SleepQ,Rested,Wired,EarlyWake,RestHR,StandHR,Anxiety,Mood,Energy,Nausea,NewPain,Headache,Fatigue,Panic,Stress,Period,CycleDay,Adherence,Notes\n" + ds.map(d => { const l = logs[d]; return [d, l?.dayRating || "", l?.sleep?.quality || "", l?.sleep?.feltRested ? "Y" : "N", l?.symptoms?.wiredButTired ? "Y" : "N", l?.earlyWake ? "Y" : "N", l?.vitals?.morningHR || "", l?.vitals?.standingHR || "", l?.symptoms?.anxiety || "", l?.symptoms?.mood || "", l?.symptoms?.energy || "", l?.symptoms?.nausea || "", l?.symptoms?.painNew || "", l?.symptoms?.headache || "", l?.symptoms?.fatigue || "", l?.symptoms?.panicCount || 0, l?.stressLevel || "", l?.menstrual?.status || "", l?.menstrual?.cycleDay || "", calcAdh(l), '"' + (l?.notes || "").replace(/"/g, "'") + '"'].join(","); }).join("\n"); }
    return (<div>
      <h1 style={{ margin: "0 0 16px", fontSize: 24, fontWeight: 800, color: c.text }}>Settings</h1>
      {showSample && Object.values(logs).some(l => l._isSample) && <Card c={c} style={{ border: `1.5px solid ${c.warning}`, background: c.warningLight }}><div style={{ fontSize: 14, fontWeight: 700, color: c.text, marginBottom: 6 }}>ğŸ“Š Sample Data Active</div><div style={{ fontSize: 13, color: c.textMuted, marginBottom: 12 }}>Clear when you're ready to start!</div><button onClick={() => { setLogs(p => { const cl = {}; Object.entries(p).forEach(([k, v]) => { if (!v._isSample) cl[k] = v; }); return cl; }); setShowSample(false); }} style={{ width: "100%", padding: 12, borderRadius: 12, border: "none", background: c.warning, color: "#fff", fontSize: 14, fontWeight: 700, cursor: "pointer" }}>Clear Sample Data</button></Card>}
      <Card c={c}><SH title="Preferences" icon="âš™ï¸" c={c} />
        {[["Bedtime", "bedtime"], ["Wake time", "wakeTime"]].map(([l, k]) => <div key={k} style={{ marginBottom: 14 }}><label style={{ fontSize: 13, fontWeight: 600, color: c.text, display: "block", marginBottom: 6 }}>{l}</label><input type="time" value={prefs[k]} onChange={e => setPrefs(p => ({ ...p, [k]: e.target.value }))} style={{ width: "100%", padding: 12, borderRadius: 10, border: `1px solid ${c.border}`, background: c.bgCardAlt, color: c.text, fontSize: 15, fontFamily: "inherit", boxSizing: "border-box" }} /></div>)}
        <Toggle label="Dark mode" value={dark} onChange={setDark} c={c} />
      </Card>
      <Card c={c}><SH title="Export" icon="ğŸ“¤" c={c} />
        <div style={{ display: "flex", gap: 6, marginBottom: 14, flexWrap: "wrap" }}>{[["7", "7 Days"], ["14", "14 Days"], ["30", "30 Days"], ["all", "All Data"]].map(([v, l]) => <Pill key={v} text={l} active={expR === v} onClick={() => setExpR(v)} c={c} />)}</div>
        <button onClick={() => { setExportText(genExp(expR)); setShowExport(true); }} style={{ width: "100%", padding: 14, borderRadius: 12, border: "none", background: c.primary, color: "#fff", fontSize: 15, fontWeight: 700, cursor: "pointer", marginBottom: 10 }}>ğŸ“‹ Generate Report</button>
        <button onClick={() => { const b = new Blob([genCSV(expR)], { type: "text/csv" }); const a = document.createElement("a"); a.href = URL.createObjectURL(b); a.download = `sami_${expR}_${todayKey}.csv`; a.click(); }} style={{ width: "100%", padding: 14, borderRadius: 12, border: `2px solid ${c.primary}`, background: "transparent", color: c.primary, fontSize: 15, fontWeight: 700, cursor: "pointer" }}>ğŸ“Š Download CSV</button>
      </Card>
      <Card c={c}><SH title="Backup & Restore" icon="ğŸ’¾" c={c} />
        <button onClick={() => { const b = new Blob([JSON.stringify({ logs, prefs, dark, version: "v3" }, null, 2)], { type: "application/json" }); const a = document.createElement("a"); a.href = URL.createObjectURL(b); a.download = `sami_BACKUP_${todayKey}.json`; a.click(); }} style={{ width: "100%", padding: 14, borderRadius: 12, border: "none", background: c.success, color: "#fff", fontSize: 15, fontWeight: 700, cursor: "pointer", marginBottom: 10 }}>ğŸ’¾ Full Backup</button>
        <button onClick={() => setShowImport(true)} style={{ width: "100%", padding: 14, borderRadius: 12, border: `2px solid ${c.success}`, background: "transparent", color: c.success, fontSize: 15, fontWeight: 700, cursor: "pointer" }}>ğŸ“¥ Restore from Backup</button>
      </Card>
      <Card c={c}><SH title="Help" icon="â“" c={c} /><div style={{ fontSize: 13, color: c.textMuted, lineHeight: 1.8 }}>
        <p><b style={{ color: c.text }}>Today:</b> Daily checklist. Tap âœ“, tap ? to learn why.</p>
        <p><b style={{ color: c.text }}>Log:</b> Morning = sleep/vitals. Evening = symptoms. â€¹ â€º for past days.</p>
        <p><b style={{ color: c.text }}>Insights:</b> Charts + patterns in plain language.</p>
        <p><b style={{ color: c.text }}>Streaks:</b> 7d = ğŸ¦  21d = habit  30d = ğŸ‘‘</p>
        <p style={{ fontStyle: "italic", color: c.primary, marginTop: 12 }}>ğŸ’œ Missing a day is okay. Be kind to yourself.</p>
      </div></Card>
    </div>);
  }

  // â”€â”€â”€ Crisis Modal â”€â”€â”€
  function CrisisModal() {
    const [ct, setCT] = useState([]), [cs, setCS] = useState([]), [iv, setIV] = useState([]), [cn, setCN] = useState(""), [pn, setPN] = useState("");
    const tog = (a, s, v) => s(p => p.includes(v) ? p.filter(x => x !== v) : [...p, v]);
    return (<div style={{ position: "fixed", inset: 0, zIndex: 1000, background: "rgba(0,0,0,.5)", display: "flex", alignItems: "flex-end", justifyContent: "center" }}>
      <div style={{ background: c.bgCard, borderRadius: "24px 24px 0 0", maxWidth: 480, width: "100%", maxHeight: "90vh", overflow: "auto", padding: "24px 20px 40px" }}>
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 }}><h2 style={{ margin: 0, fontSize: 20, fontWeight: 800, color: c.crisis }}>ğŸš¨ Crisis Log</h2><button onClick={() => setShowCrisis(false)} style={{ background: "none", border: "none", fontSize: 24, color: c.textMuted, cursor: "pointer" }}>âœ•</button></div>
        <p style={{ fontSize: 13, color: c.textMuted, marginBottom: 16 }}>You're safe. Take your time.</p>
        <SH title="What's happening?" c={c} />
        <div style={{ display: "flex", flexWrap: "wrap", gap: 8, marginBottom: 16 }}>{[["severe_panic", "Severe Panic"], ["er_visit", "ER Visit"], ["cant_sleep", "Can't Sleep >3hrs"], ["hr_over_120", "HR >120"], ["severe_gi", "Severe GI"], ["extreme_wired", "Extreme Wired"]].map(([k, l]) => <Pill key={k} text={l} active={ct.includes(k)} onClick={() => tog(ct, setCT, k)} c={c} color={c.crisis} />)}</div>
        <SH title="Symptoms" c={c} />
        <div style={{ display: "flex", flexWrap: "wrap", gap: 8, marginBottom: 16 }}>{[["racing_heart", "Racing Heart"], ["cant_breathe", "Can't Breathe"], ["nausea", "Nausea"], ["panic", "Panic/Fear"], ["racing_mind", "Racing Mind"], ["dizzy", "Dizzy/Faint"]].map(([k, l]) => <Pill key={k} text={l} active={cs.includes(k)} onClick={() => tog(cs, setCS, k)} c={c} color={c.warning} />)}</div>
        <SH title="What helped?" c={c} />
        <div style={{ display: "flex", flexWrap: "wrap", gap: 8, marginBottom: 16 }}>{[["cold_water", "Cold Water"], ["breathing", "Breathing"], ["extra_med", "Extra Meds"], ["called_doc", "Called Doctor"], ["er", "Went to ER"]].map(([k, l]) => <Pill key={k} text={l} active={iv.includes(k)} onClick={() => tog(iv, setIV, k)} c={c} color={c.success} />)}</div>
        <textarea value={cn} onChange={e => setCN(e.target.value)} placeholder="What's different today?" rows={2} style={{ width: "100%", padding: 12, borderRadius: 10, border: `1px solid ${c.border}`, background: c.bgCardAlt, color: c.text, fontSize: 14, fontFamily: "inherit", resize: "vertical", boxSizing: "border-box", marginBottom: 10 }} />
        <textarea value={pn} onChange={e => setPN(e.target.value)} placeholder="Partner notes (Trevor)" rows={2} style={{ width: "100%", padding: 12, borderRadius: 10, border: `1px solid ${c.border}`, background: c.bgCardAlt, color: c.text, fontSize: 14, fontFamily: "inherit", resize: "vertical", boxSizing: "border-box", marginBottom: 16 }} />
        <button onClick={() => { updateLog(todayKey, p => ({ ...p, crisisEvents: [...(p.crisisEvents || []), { timestamp: new Date().toISOString(), type: ct, symptoms: cs, interventions: iv, note: cn, partnerNote: pn }], dayRating: "crisis" })); setShowCrisis(false); }} style={{ width: "100%", padding: 16, borderRadius: 14, border: "none", background: c.crisis, color: "#fff", fontSize: 16, fontWeight: 700, cursor: "pointer" }}>Save Crisis Log</button>
      </div>
    </div>);
  }

  if (!loaded) return <div style={{ minHeight: "100vh", display: "flex", alignItems: "center", justifyContent: "center", background: c.bg }}><div style={{ textAlign: "center", color: c.textMuted }}><div style={{ fontSize: 32, marginBottom: 12 }}>ğŸ’œ</div><div style={{ fontSize: 16, fontWeight: 600 }}>Loading...</div></div></div>;

  return (<div style={{ minHeight: "100vh", background: c.bg }}>
    <div style={{ position: "sticky", top: 0, zIndex: 50, background: c.bg + "ee", backdropFilter: "blur(10px)", borderBottom: `1px solid ${c.border}`, padding: "12px 20px", display: "flex", justifyContent: "space-between", alignItems: "center" }}>
      <span style={{ fontSize: 16, fontWeight: 800, color: c.primary }}>ğŸ’œ Sami's Health</span>
      <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
        {streak > 0 && <span style={{ fontSize: 12, fontWeight: 700, color: c.streak, background: c.streak + "15", padding: "2px 8px", borderRadius: 8 }}>{reward.emoji} {streak}</span>}
        <span style={{ fontSize: 12, color: c.textMuted }}>{new Date().toLocaleDateString("en-US", { weekday: "short", month: "short", day: "numeric" })}</span>
      </div>
    </div>
    <div style={{ padding: "12px 16px 100px", maxWidth: 480, margin: "0 auto", overflowY: "auto", height: "calc(100vh - 110px)", WebkitOverflowScrolling: "touch" }}>
      {tab === "today" && <TodayView />}
      {tab === "log" && <LogView />}
      {tab === "insights" && <InsightsView />}
      {tab === "settings" && <SettingsView />}
    </div>
    <button onClick={() => setShowCrisis(true)} style={{ position: "fixed", bottom: 76, right: 16, zIndex: 100, width: 52, height: 52, borderRadius: 26, background: c.crisis, border: "none", color: "#fff", fontSize: 22, display: "flex", alignItems: "center", justifyContent: "center", cursor: "pointer", boxShadow: `0 4px 16px ${c.crisis}40` }}>ğŸš¨</button>
    <nav style={{ position: "fixed", bottom: 0, left: 0, right: 0, zIndex: 50, background: c.bgCard, borderTop: `1px solid ${c.border}`, display: "flex", justifyContent: "space-around", padding: "6px 0 max(6px, env(safe-area-inset-bottom))" }}>
      {[["today", "ğŸ ", "Today"], ["log", "ğŸ“", "Log"], ["insights", "ğŸ“Š", "Insights"], ["settings", "âš™ï¸", "Settings"]].map(([k, ic, l]) => <button key={k} onClick={() => { setTab(k); if (k !== "log" && k !== "today") setViewDate(null); }} style={{ background: "none", border: "none", display: "flex", flexDirection: "column", alignItems: "center", gap: 2, padding: "4px 12px", cursor: "pointer" }}><span style={{ fontSize: 20, opacity: tab === k ? 1 : 0.5 }}>{ic}</span><span style={{ fontSize: 10, fontWeight: 600, color: tab === k ? c.primary : c.textMuted }}>{l}</span></button>)}
    </nav>
    {showCrisis && <CrisisModal />}
    {showExport && <div style={{ position: "fixed", inset: 0, zIndex: 1000, background: "rgba(0,0,0,.5)", display: "flex", alignItems: "flex-end", justifyContent: "center" }}><div style={{ background: c.bgCard, borderRadius: "24px 24px 0 0", maxWidth: 480, width: "100%", maxHeight: "90vh", overflow: "auto", padding: "24px 20px 40px" }}>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 }}><h2 style={{ margin: 0, fontSize: 18, fontWeight: 800, color: c.text }}>ğŸ“‹ Report</h2><button onClick={() => setShowExport(false)} style={{ background: "none", border: "none", fontSize: 24, color: c.textMuted, cursor: "pointer" }}>âœ•</button></div>
      <pre style={{ fontSize: 11, color: c.text, background: c.bgCardAlt, padding: 16, borderRadius: 12, overflow: "auto", maxHeight: 360, whiteSpace: "pre-wrap", lineHeight: 1.5 }}>{exportText}</pre>
      <div style={{ display: "flex", gap: 10, marginTop: 16 }}><button onClick={() => { navigator.clipboard?.writeText(exportText).then(() => alert("Copied!")); }} style={{ flex: 1, padding: 14, borderRadius: 12, border: "none", background: c.primary, color: "#fff", fontSize: 14, fontWeight: 700, cursor: "pointer" }}>ğŸ“‹ Copy</button><button onClick={() => { const b = new Blob([exportText], { type: "text/plain" }); const a = document.createElement("a"); a.href = URL.createObjectURL(b); a.download = "sami_report.txt"; a.click(); }} style={{ flex: 1, padding: 14, borderRadius: 12, border: `2px solid ${c.primary}`, background: "transparent", color: c.primary, fontSize: 14, fontWeight: 700, cursor: "pointer" }}>ğŸ’¾ Download</button></div>
    </div></div>}
    {showImport && <div style={{ position: "fixed", inset: 0, zIndex: 1000, background: "rgba(0,0,0,.5)", display: "flex", alignItems: "center", justifyContent: "center", padding: 20 }}><div style={{ background: c.bgCard, borderRadius: 20, maxWidth: 400, width: "100%", padding: 24 }}>
      <h2 style={{ margin: "0 0 12px", fontSize: 18, fontWeight: 800, color: c.text }}>ğŸ“¥ Restore</h2>
      <p style={{ fontSize: 13, color: c.textMuted, marginBottom: 16 }}>Select a .json backup to replace current data.</p>
      <input type="file" accept=".json" onChange={e => { const f = e.target.files?.[0]; if (!f) return; const r = new FileReader(); r.onload = ev => { try { const d = JSON.parse(ev.target.result); if (d.logs && confirm("Found " + Object.keys(d.logs).length + " days. Replace?")) { setLogs(d.logs); if (d.prefs) setPrefs(d.prefs); if (d.dark !== undefined) setDark(d.dark); setShowImport(false); alert("Restored!"); } } catch { alert("Invalid file."); } }; r.readAsText(f); }} style={{ marginBottom: 16 }} />
      <button onClick={() => setShowImport(false)} style={{ width: "100%", padding: 12, borderRadius: 12, border: `2px solid ${c.border}`, background: "transparent", color: c.textMuted, fontSize: 14, fontWeight: 600, cursor: "pointer" }}>Cancel</button>
    </div></div>}
  </div>);
}

ReactDOM.render(<App />, document.getElementById("root"));
</script>
</body>
</html>
